name: Deploy to EC2 (Docker + Traefik)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 20m
          script: |
            set -e
            APP_DIR="/home/ubuntu/app"
            
            echo "=== Preparando directorio ==="
            mkdir -p $APP_DIR
            cd $APP_DIR
            
            echo "=== Creando .env ==="
            cat > .env << 'ENVEOF'
            APP_ENV=${{ secrets.APP_ENV }}
            PORT=8080
            MONGO_URI=${{ secrets.MONGO_URI }}
            MONGO_DATABASE=${{ secrets.MONGO_DATABASE }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRATION_MINS=${{ secrets.JWT_EXPIRATION_MINS }}
            JWT_REFRESH_EXPIRATION_DAYS=${{ secrets.JWT_REFRESH_EXPIRATION_DAYS }}
            DOMAIN=${{ secrets.DOMAIN }}
            ACME_EMAIL=${{ secrets.ACME_EMAIL }}
            ENVEOF
            
            echo "=== Creando traefik.yml ==="
            cat > traefik.yml << 'TRAEFIKEOF'
            api:
              dashboard: false
            
            entryPoints:
              web:
                address: ":80"
                http:
                  redirections:
                    entryPoint:
                      to: websecure
                      scheme: https
              websecure:
                address: ":443"
            
            providers:
              docker:
                endpoint: "unix:///var/run/docker.sock"
                exposedByDefault: false
            
            certificatesResolvers:
              letsencrypt:
                acme:
                  email: ${{ secrets.ACME_EMAIL }}
                  storage: /acme.json
                  httpChallenge:
                    entryPoint: web
            TRAEFIKEOF
            
            echo "=== Creando docker-compose.yml ==="
            cat > docker-compose.yml << 'COMPOSEEOF'
            services:
              traefik:
                image: traefik:v3.0
                container_name: traefik
                restart: unless-stopped
                command:
                  - "--configFile=/etc/traefik/traefik.yml"
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - /var/run/docker.sock:/var/run/docker.sock:ro
                  - ./traefik.yml:/etc/traefik/traefik.yml:ro
                  - ./acme.json:/acme.json
                networks:
                  - web
            
              api:
                image: ghcr.io/zabaletac3/template_golang:latest
                container_name: api
                restart: unless-stopped
                env_file:
                  - .env
                labels:
                  - "traefik.enable=true"
                  - "traefik.http.routers.api.rule=Host(\`${{ secrets.DOMAIN }}\`)"
                  - "traefik.http.routers.api.entrypoints=websecure"
                  - "traefik.http.routers.api.tls.certresolver=letsencrypt"
                  - "traefik.http.services.api.loadbalancer.server.port=8080"
                networks:
                  - web
                depends_on:
                  - traefik
            
            networks:
              web:
                driver: bridge
            COMPOSEEOF
            
            echo "=== Creando acme.json ==="
            touch acme.json
            chmod 600 acme.json
            
            echo "=== Pulling imagen ==="
            docker pull ghcr.io/zabaletac3/template_golang:latest
            
            echo "=== Deteniendo contenedores anteriores ==="
            docker stop go-api traefik api || true
            docker rm go-api traefik api || true
            
            echo "=== Iniciando con docker-compose ==="
            docker compose up -d
            
            sleep 10
            echo "=== Estado de contenedores ==="
            docker ps
            
            echo "=== Health check ==="
            curl -sf http://localhost:8080/health && echo " âœ… API OK" || docker logs api --tail 20
